# 会话管理功能说明

## 功能概述

在 `websocket_simulator2.0.py` 中新增了全局会话管理功能，实现以下特性：

- **凭证持久化**: 凭证在整个程序运行期间保持有效
- **任务完成后返回主菜单**: 不再需要重启脚本
- **凭证复用**: 多个任务可以使用同一组凭证
- **401错误自动处理**: 检测到凭证过期时自动清除并提示重新登录
- **智能参数记忆**: Git参数（项目ID、仓库ID）也会保存到会话中

## 主要改进

### 1. 全局凭证管理器

新增 `CredentialManager` 类来管理会话级别的凭证：

```python
class CredentialManager:
    - invoker_id: 用户ID
    - session_id: 会话ID
    - project_id: Git项目ID
    - repository_id: Git仓库ID
```

**核心方法**:
- `set_credentials(invoker_id, session_id)` - 保存凭证
- `get_credentials()` - 获取凭证
- `has_credentials()` - 检查是否有凭证
- `clear_credentials()` - 清除凭证（401错误时调用）
- `set_git_params(project_id, repository_id)` - 保存Git参数

### 2. 循环主菜单

主菜单改为持续循环模式，不再在任务完成后退出：

```python
async def main():
    while True:
        # 显示凭证状态
        if credential_manager.has_credentials():
            print(f"\n💾 当前会话凭证: Invoker ID = {credential_manager.invoker_id}")

        # 显示主菜单
        choice = print_menu()

        # 执行任务后返回主菜单，继续循环
```

### 3. 任务完成提示

所有任务（辅助编程、Git提交）完成后都会显示提示：

```
✅ 任务执行完成！

==================================================
按 Enter 键返回主菜单...
==================================================
```

### 4. 凭证复用提示

每个模式（半自动、手动、Git提交）都会检查是否已有凭证：

```
💾 检测到当前会话已有凭证
   Invoker ID: 186812
   Session ID: c699b466-3e35-4cc1-b3ec...

是否使用现有凭证? (y/n, 默认 y):
```

- 选择 `y` 或直接回车：使用现有凭证
- 选择 `n`：重新登录获取新凭证

### 5. 401错误自动处理

在Git提交的两个API调用中增加了401检测：

```python
if response.status_code == 401:
    print(f"[{invoker_id}] ❌ 认证失败 (401)")
    print(f"[{invoker_id}] 凭证已过期或无效，请重新登录")
    credential_manager.clear_credentials()  # 自动清除凭证
    return False
```

当检测到401错误时：
1. 打印错误信息
2. 自动清除会话中的凭证
3. 返回主菜单
4. 下次执行任务时会提示重新登录

## 使用场景

### 场景 1: 连续执行多个任务

```
1. 启动脚本
2. 选择 "辅助编程" -> "半自动模式"
3. 浏览器登录，获取凭证
4. 执行代码补全任务
5. 任务完成后按Enter返回主菜单
6. 选择 "Git 提交"
7. 系统提示使用现有凭证，按y确认
8. 系统提示使用会话中保存的Git参数
9. 执行Git提交任务
10. 任务完成后按Enter返回主菜单
11. 继续选择其他任务或退出
```

**优势**: 只需登录一次，凭证和参数都会复用

### 场景 2: 凭证过期处理

```
1. 执行Git提交任务
2. 收到401错误：❌ 认证失败 (401)
3. 系统自动清除凭证
4. 返回主菜单
5. 再次选择任务时，提示重新登录
6. 使用半自动或手动模式重新获取凭证
7. 继续执行任务
```

**优势**: 无需重启脚本，只需重新登录

### 场景 3: 切换账号

```
1. 使用账号A的凭证执行任务
2. 任务完成后返回主菜单
3. 选择任意模式
4. 当提示"是否使用现有凭证"时，输入 n
5. 重新登录或输入账号B的凭证
6. 使用新凭证执行任务
```

**优势**: 可以在同一个会话中切换账号

## 菜单结构

### 主菜单
```
请选择功能:
  1. 🤖 辅助编程
  2. 🔨 Git 提交 (模拟Git提交操作)
  3. 🚪 退出
```

### 辅助编程子菜单
```
辅助编程 - 请选择运行模式:
  1. 🤖 半自动模式 (浏览器自动打开，手动登录，自动提取凭证) ⭐ 推荐
  2. ✋ 手动模式 (直接输入凭证)
  3. 📦 批量模式 (从文件导入多账号)
  4. 📝 生成配置文件模板
  5. 🔙 返回上级菜单
```

## 凭证状态显示

当有凭证时，主菜单会显示当前凭证状态：

```
💾 当前会话凭证: Invoker ID = 186812

请选择功能:
  1. 🤖 辅助编程
  2. 🔨 Git 提交 (模拟Git提交操作)
  3. 🚪 退出
```

## Ctrl+C 处理

按下 Ctrl+C 时会弹出确认提示：

```
⚠️  检测到 Ctrl+C
是否退出程序? (y/n):
```

- 输入 `y`: 退出程序
- 输入 `n`: 继续运行，返回主菜单

## 技术实现细节

### 凭证保存时机

1. **半自动模式**: 浏览器登录成功后立即保存
2. **手动模式**: 用户输入凭证后立即保存
3. **Git提交模式**:
   - 使用半自动或手动获取凭证后保存
   - Git参数（项目ID、仓库ID）也会保存

### 凭证清除时机

1. **用户主动清除**: 选择重新登录时
2. **401错误**: 自动清除并提示重新登录
3. **程序退出**: 凭证随程序结束而清除（未持久化到文件）

### Git参数记忆

Git提交模式下，项目ID和仓库ID会保存到会话中：

```python
credential_manager.set_git_params(project_id, repository_id)
```

下次执行Git提交时会提示：

```
💾 使用会话中保存的参数:
   项目ID: 25718
   仓库ID: 342513

是否使用这些参数? (y/n, 默认 y):
```

## 与之前版本的对比

| 特性 | 旧版本 | 新版本 |
|------|--------|--------|
| 任务完成后 | 退出程序 | 返回主菜单 |
| 多任务执行 | 需要重启脚本 | 无需重启 |
| 凭证管理 | 每次输入 | 会话级复用 |
| 401错误处理 | 手动重启 | 自动清除凭证并提示 |
| 菜单结构 | 扁平6选项 | 嵌套3+5选项 |
| Ctrl+C处理 | 直接退出 | 确认提示 |
| Git参数 | 每次输入 | 会话级记忆 |

## 用户体验提升

✅ **减少重复操作**: 只需登录一次，可执行多个任务
✅ **智能参数记忆**: Git参数自动保存，无需重复输入
✅ **友好错误处理**: 401错误自动清除凭证，提示重新登录
✅ **灵活凭证管理**: 可以随时切换账号或刷新凭证
✅ **清晰状态提示**: 实时显示当前凭证状态
✅ **安全退出**: Ctrl+C需要确认，防止误操作

## 注意事项

1. **凭证安全**: 凭证仅保存在内存中，程序退出后不会持久化
2. **会话有效期**: 凭证的有效期由服务端控制，过期后会收到401错误
3. **并发限制**: 同一个会话凭证不建议在多个实例中同时使用
4. **批量模式**: 批量模式仍然使用配置文件中的凭证，不受会话管理影响

## 更新日志

### v2.2 新增
- ✅ 全局凭证管理器 (CredentialManager)
- ✅ 任务完成后返回主菜单
- ✅ 凭证复用提示
- ✅ 401错误自动处理
- ✅ Git参数会话级记忆
- ✅ Ctrl+C确认提示
- ✅ 实时凭证状态显示
- ✅ 菜单结构优化（嵌套）
